<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">

<!-- This HTML file generated by cxref. -->
<!-- cxref program (c) Andrew M. Bishop 1995,96,97,98,99. -->

<!--
Cxref: cxref -DTN_SRV -Id:/djgpp/include -O../doc/cxref -xref-all -Nsv2agw -index-all -html32 -html32-src test.c
CPP  : gcc -E -C -dD -dI -DTN_SRV -Id:/djgpp/include
-->

<HTML>

<HEAD>
<TITLE>Source File test.c</TITLE>
</HEAD>

<BODY>

<pre>
<a name="line1">1    |</a> /*
<a name="line2">2    |</a>  $Header: /djgpp/sv2agw/test2.c 1.0 Fri 07-21-2000 3:26:47 pm $
<a name="line3">3    |</a> 
<a name="line4">4    |</a>  * SV2AGW DJGPP libsocket interface for DJGPP.
<a name="line5">5    |</a>  * This is the first test version which bypasses all recommendations
<a name="line6">6    |</a>  * of LU7DID and SV2AGW, but it is a quick start to see if it works
<a name="line7">7    |</a>  *
<a name="line8">8    |</a>  * Copyright 1997, 1998 by Indrek Mandre
<a name="line9">9    |</a>  * Copyright 2000 by Henk van Asselt, PA3BTL email: pa3btl@amsat.org
<a name="line10">10   |</a>  */
<a name="line11">11   |</a> 
<a name="line12">12   |</a> /*
<a name="line13">13   |</a>  * News:
<a name="line14">14   |</a>  * 
<a name="line15">15   |</a>  * 20000707: Initial version
<a name="line16">16   |</a>  *
<a name="line17">17   |</a>  */
<a name="line18">18   |</a> 
<a name="line19">19   |</a> /*+ Include file  +*/
<a name="line20">20   |</a> #include &lt;stdio.h&gt;
<a name="line21">21   |</a> #include &lt;stdlib.h&gt;
<a name="line22">22   |</a> #include &lt;string.h&gt;
<a name="line23">23   |</a> #include &lt;netinet/in.h&gt;
<a name="line24">24   |</a> #include &lt;sys/socket.h&gt;
<a name="line25">25   |</a> #include &lt;netdb.h&gt;
<a name="line26">26   |</a> #include &lt;arpa/inet.h&gt;
<a name="line27">27   |</a> #include &lt;unistd.h&gt;
<a name="line28">28   |</a> #include &lt;lsck/copyrite.h&gt;
<a name="line29">29   |</a> 
<a name="line30">30   |</a> #include &lt;fcntl.h&gt;          /*+ RD: For fcntl() -&gt; non-blocking I/O +*/
<a name="line31">31   |</a> 
<a name="line32">32   |</a> #include &quot;fortify.h&quot;
<a name="line33">33   |</a> #include &quot;agwhdr.h&quot;
<a name="line34">34   |</a> #include &quot;agwpe_if.h&quot;
<a name="line35">35   |</a> #include &quot;agwsubs.h&quot;
<a name="line36">36   |</a> #include &quot;tn_srv.h&quot;
<a name="line37">37   |</a> #include &quot;cmd.h&quot;
<a name="line38">38   |</a> 
<a name="line39">39   |</a> /*----------------------------------------
<a name="line40">40   |</a>   variables
<a name="line41">41   |</a> ------------------------------------------*/
<a name="line42">42   |</a> 
<a name="line43">43   |</a> unsigned char cmd[60];	/* command wich will be send to AGWPE */
<a name="line44">44   |</a> BYTE data[512];
<a name="line45">45   |</a> 
<a name="line46">46   |</a> extern char agwpe_version[];
<a name="line47">47   |</a> extern char agwpe_portinfo[];
<a name="line48">48   |</a> 
<a name="line49">49   |</a> static RINGBUF *tn_ringbuf;	 		/*+ Ringbuffer for incoming telnet data +*/
<a name="line50">50   |</a> int telnet_sock;
<a name="line51">51   |</a> 
<a name="line52">52   |</a> /*+ External varialbles +*/
<a name="line53">53   |</a> extern int agwpe_status;	  /*+ status of connection to AGWPE +*/
<a name="line54">54   |</a> extern char mycall[];		  /*+ mycall is an external string +*/
<a name="line55">55   |</a> extern char tocall[];		  /*+ tocall is an external string +*/
<a name="line56">56   |</a> 
<a name="line57">57   |</a> /*----------------------------------------
<a name="line58">58   |</a> FUNC: main()
<a name="line59">59   |</a> DESC:
<a name="line60">60   |</a> HIST: 20000708 - Initial version
<a name="line61">61   |</a> ------------------------------------------*/
<a name="line62">62   |</a> int main( int argc, char *argv[] )
<a name="line63">63   |</a> {
<a name="line64">64   |</a>   int ret;						/*+ A return value  +*/
<a name="line65">65   |</a>   char *cmd;
<a name="line66">66   |</a>   int len;
<a name="line67">67   |</a> 
<a name="line68">68   |</a>   /*--- Print the version of libsocket used  */
<a name="line69">69   |</a>   printf(&quot;%s\n&quot;,__lsck_get_version());
<a name="line70">70   |</a> 
<a name="line71">71   |</a>   /*--- Set mycall  */
<a name="line72">72   |</a>   strcpy(mycall,&quot;PA3BTL-5&quot;);
<a name="line73">73   |</a> 
<a name="line74">74   |</a> #ifdef TN_SRV
<a name="line75">75   |</a>   /*--- Setup telnet socket to listen on  */  
<a name="line76">76   |</a>   telnet_srv_init(&quot;23&quot;);
<a name="line77">77   |</a> #endif
<a name="line78">78   |</a> 
<a name="line79">79   |</a>   /*--- Create ringbuffer for incoming telnet and console data  */
<a name="line80">80   |</a>   tn_ringbuf = ringbuf_create(2048);
<a name="line81">81   |</a> 
<a name="line82">82   |</a>   /*--- Setup TCP connection to AGWPE */
<a name="line83">83   |</a>   printf(&quot;\nEstablishing connection to AGWPE &quot;);
<a name="line84">84   |</a>   ret = agwpe_init(&quot;127.0.0.1&quot;,&quot;8000&quot;);
<a name="line85">85   |</a>   if (ret &gt; 0) {
<a name="line86">86   |</a>     printf(&quot;Initialization successfull&quot;);
<a name="line87">87   |</a>   }
<a name="line88">88   |</a>   else
<a name="line89">89   |</a>   {
<a name="line90">90   |</a>     /*--- Failure making connection. Exit this program  */
<a name="line91">91   |</a>     exit(-1);
<a name="line92">92   |</a>   }
<a name="line93">93   |</a> 
<a name="line94">94   |</a>   printf(&quot;AGWPE version  : %s\n&quot;,agwpe_version);
<a name="line95">95   |</a>   printf(&quot;AGWPE portinfo : %s\n&quot;,agwpe_portinfo);
<a name="line96">96   |</a>   
<a name="line97">97   |</a>   /*--- Test registration  ---*/
<a name="line98">98   |</a>   agwpe_register(mycall);
<a name="line99">99   |</a>   agwpe_process();
<a name="line100">100  |</a> 
<a name="line101">101  |</a> #if defined(USE_FORTIFY)
<a name="line102">102  |</a>   Fortify_ListAllMemory();
<a name="line103">103  |</a>   // Fortify_OutputStatistics();
<a name="line104">104  |</a> #endif
<a name="line105">105  |</a> 
<a name="line106">106  |</a>   // Do your things here
<a name="line107">107  |</a>   // agwpe_monitor();
<a name="line108">108  |</a> 
<a name="line109">109  |</a>   // Start in command mode. Even if there is no telnet client
<a name="line110">110  |</a>   // Connected, we still want to do something from the command prompt
<a name="line111">111  |</a>   // on the console
<a name="line112">112  |</a>   agwpe_status |= CMD_MODE;
<a name="line113">113  |</a> 
<a name="line114">114  |</a>   printf(&quot;\nStarting endless loop ...\n&quot;);
<a name="line115">115  |</a>   for (;;) {
<a name="line116">116  |</a> #ifdef TN_SRV
<a name="line117">117  |</a>     if (!((agwpe_status &amp; TN_LISTENING) || (agwpe_status &amp; TN_CONNECTED)))
<a name="line118">118  |</a> 	  telnet_srv_init(&quot;23&quot;);
<a name="line119">119  |</a>     else if (agwpe_status &amp; TN_LISTENING)
<a name="line120">120  |</a>       (void) check_conn_request();
<a name="line121">121  |</a> 	else if (agwpe_status &amp; TN_CONNECTED) {
<a name="line122">122  |</a> 	  telnet_sock = get_telnet_sock();
<a name="line123">123  |</a>       ret = get_telnet_data(tn_ringbuf,telnet_sock);
<a name="line124">124  |</a>   	  if (ret == -1) { 
<a name="line125">125  |</a> 	    tn_close_all();
<a name="line126">126  |</a>   	  }
<a name="line127">127  |</a> 	}
<a name="line128">128  |</a> #endif
<a name="line129">129  |</a> 	get_con_data(tn_ringbuf);
<a name="line130">130  |</a>     agwpe_process();
<a name="line131">131  |</a> 	cmd = get_cmd(tn_ringbuf);				/*--- See if there is a command available  */
<a name="line132">132  |</a> 	if (cmd) { 
<a name="line133">133  |</a> 	  if (agwpe_status &amp; CMD_MODE) {
<a name="line134">134  |</a> 	    exec_cmd(cmd);						/*--- Execute the command  */
<a name="line135">135  |</a> 	    disp_prompt();
<a name="line136">136  |</a> 	  }
<a name="line137">137  |</a> 	  else if (agwpe_status &amp; STATION_CONNECTED) {
<a name="line138">138  |</a> 		len = strlen(cmd);
<a name="line139">139  |</a> 		cmd[len]='\r';
<a name="line140">140  |</a> 		cmd[len+1]='\0';
<a name="line141">141  |</a> 	    agwpe_send_data(0,tocall,cmd);
<a name="line142">142  |</a> 	  }
<a name="line143">143  |</a> 	}
<a name="line144">144  |</a>   }
<a name="line145">145  |</a> 
<a name="line146">146  |</a>   /*--- Close connection  ---*/
<a name="line147">147  |</a>   agwpe_unregister(mycall);
<a name="line148">148  |</a>   agw_tcp_close();
<a name="line149">149  |</a> 
<a name="line150">150  |</a> #if defined(USE_FORTIFY)
<a name="line151">151  |</a>   Fortify_ListAllMemory();
<a name="line152">152  |</a>   // Fortify_OutputStatistics();
<a name="line153">153  |</a> #endif
<a name="line154">154  |</a> 
<a name="line155">155  |</a>   return 0;
<a name="line156">156  |</a> }
<a name="line157">157  |</a> 
<a name="line158">158  |</a> 
</pre>

</BODY>
</HTML>
